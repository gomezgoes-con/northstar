<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NorthStar - Query Analyzer for StarRocks</title>
  <link rel="icon" type="image/png" href="northstar_dark.png">

  <!-- Google Font: JetBrains Mono for that data/code feel -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Theme initialization (prevents flash of wrong theme) -->
  <script>
    (function() {
      const saved = localStorage.getItem('northstar-theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      document.documentElement.setAttribute('data-theme', saved || (prefersDark ? 'dark' : 'light'));
    })();
  </script>

  <!-- Styles -->
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>
  <!-- ========================================
       Header Section
       ======================================== -->
  <header>
    <div class="header-left">
      <a href="./" class="logo-link" id="logoLink">
        <img src="northstar_dark.png" alt="NorthStar Logo" class="logo-img">
        <div class="logo">NorthStar</div>
      </a>
      <h1>Query Analyzer for StarRocks</h1>
    </div>
    <div class="header-right">
      <button class="btn-load-query" id="globalLoadBtn">Load Query</button>
      <button class="btn-share" id="globalShareBtn" style="display: none;">Share</button>
      <input type="file" id="globalFileInput" accept=".json" style="display: none;">
      <button class="btn-theme-toggle" id="themeToggle" title="Toggle theme">
        <span class="theme-icon-dark">‚òÄÔ∏è</span>
        <span class="theme-icon-light">üåô</span>
      </button>
    </div>
  </header>

  <!-- Load Query Modal -->
  <div class="modal" id="loadModal" style="display: none;">
    <div class="modal-content">
      <h2>Load Query Profile</h2>
      <div class="load-options">
        <button class="load-option-btn" id="loadFromFile">
          <span class="load-icon">üìÅ</span>
          <span class="load-label">Upload File</span>
          <span class="load-desc">Load from your computer</span>
        </button>
        <button class="load-option-btn" id="loadFromUrl">
          <span class="load-icon">üîó</span>
          <span class="load-label">Load from URL</span>
          <span class="load-desc">GitHub Gist or Paste URL</span>
        </button>
      </div>
      <div class="url-input-container" id="urlInputContainer" style="display: none;">
        <input type="text" id="urlInput" placeholder="https://gist.github.com/... or https://dpaste.com/...">
        <div class="url-actions">
          <button class="btn-cancel" id="btnCancelUrl">Cancel</button>
          <button class="btn-load" id="btnLoadUrl">Load</button>
        </div>
      </div>
      <button class="modal-close" id="closeModal">√ó</button>
    </div>
  </div>

  <!-- Share Modal -->
  <div class="modal" id="shareModal" style="display: none;">
    <div class="modal-content">
      <h2>Share Query Profile</h2>
      <div class="share-warning">
        <div class="warning-icon">‚ö†Ô∏è</div>
        <div class="warning-text">
          <p><strong>This will create a PUBLIC paste on dpaste.com</strong></p>
          <p>Anyone with the link can view your query profile.</p>
          <p>The paste will expire after 1 year.</p>
        </div>
      </div>
      <div class="share-actions">
        <button class="btn-cancel" id="btnCancelShare">Cancel</button>
        <button class="btn-confirm" id="btnConfirmShare">Create Share Link</button>
      </div>
      <button class="modal-close" id="closeShareModal">√ó</button>
    </div>
  </div>

  <div class="modal-backdrop" id="modalBackdrop" style="display: none;"></div>

  <!-- Loading overlay for URL loading -->
  <div class="loading-overlay" id="loadingOverlay" style="display: none;">
    <div class="loading-content">
      <img src="northstar_dark.png" alt="Loading..." class="loading-logo loading-logo-dark">
      <img src="northstar_light.png" alt="Loading..." class="loading-logo loading-logo-light">
      <p id="loadingMessage">Loading query...</p>
    </div>
  </div>

  <!-- ========================================
       Tab Navigation
       ======================================== -->
  <nav class="tab-nav">
    <button class="tab-btn active" data-tab="overview">Overview</button>
    <button class="tab-btn" data-tab="scan">Scan Summary</button>
    <button class="tab-btn" data-tab="join">Join Summary</button>
    <button class="tab-btn" data-tab="plan">Query Plan</button>
    <button class="tab-btn" data-tab="raw">Raw JSON</button>
    <button class="tab-btn" data-tab="compare">Query Comparison</button>
  </nav>

  <!-- ========================================
       Main Content
       ======================================== -->
  <main>
    <!-- ====== OVERVIEW TAB ====== -->
    <div class="tab-panel active" id="tab-overview">
      <!-- Drop Zone for Overview -->
      <div class="drop-zone" id="overviewDropZone">
        <div class="drop-zone-icon">üìÅ</div>
        <h2>Drop your query profile JSON here</h2>
        <p>or click to load query</p>
        <input type="file" id="overviewFileInput" accept=".json">
      </div>

      <!-- Overview Dashboard (hidden until file loaded) -->
      <div class="dashboard" id="overviewDashboard">
        <!-- Query Summary -->
        <section class="query-info">
          <div class="query-info-header">
            <h2>Query Summary</h2>
          </div>
          <div class="query-meta" id="overviewQueryMeta">
            <!-- Populated by JavaScript -->
          </div>
        </section>

        <!-- Pipeline Timeline -->
        <section class="pipeline-timeline" id="pipelineTimeline">
          <h3 class="section-header">Pipeline Timeline <span class="section-subtitle">(by Active Time)</span></h3>
          <div class="timeline-legend">
            <span class="legend-item"><span class="legend-color active"></span> Active</span>
            <span class="legend-item"><span class="legend-color schedule"></span> Schedule</span>
            <span class="legend-item"><span class="legend-color waiting"></span> Waiting</span>
          </div>
          <div class="timeline-container" id="timelineContainer">
            <!-- Populated by JavaScript -->
          </div>
        </section>

        <!-- Quick Stats -->
        <section class="quick-stats" id="quickStats">
          <h3 class="section-header">Execution Stats</h3>
          <div class="quick-stats-grid" id="quickStatsGrid">
            <!-- Populated by JavaScript -->
          </div>
        </section>
      </div>
    </div>

    <!-- ====== SCAN SUMMARY TAB ====== -->
    <div class="tab-panel" id="tab-scan">
      <!-- Drop Zone: Visible initially for file upload -->
      <div class="drop-zone" id="dropZone">
        <div class="drop-zone-icon">üìÅ</div>
        <h2>Drop your query profile JSON here</h2>
        <p>or click to load query</p>
        <input type="file" id="fileInput" accept=".json">
      </div>

    <!-- Dashboard: Hidden until a file is loaded -->
    <div class="dashboard" id="dashboard">
      
      <!-- Query Info Panel -->
      <section class="query-info">
        <div class="query-info-header">
          <h2>Query Information</h2>
        </div>
        <div class="query-meta" id="queryMeta">
          <!-- Populated by JavaScript -->
        </div>
      </section>

      <!-- Summary Cards - Organized in Sections -->
      <div class="cards-container">
        <section class="cards-section" id="memoryCards">
          <h3 class="section-title">Memory</h3>
          <div class="summary-cards">
            <!-- Populated by JavaScript -->
          </div>
        </section>
        
        <section class="cards-section" id="timeCards">
          <h3 class="section-title">Time</h3>
          <div class="summary-cards">
            <!-- Populated by JavaScript -->
          </div>
        </section>
        
        <section class="cards-section" id="scanCards">
          <h3 class="section-title">Scan Metrics</h3>
          <div class="summary-cards">
            <!-- Populated by JavaScript -->
          </div>
        </section>
      </div>

      <!-- CONNECTOR_SCAN Table -->
      <section class="table-section">
        <div class="table-header">
          <h2>üîç CONNECTOR_SCAN Operators</h2>
        </div>
        <div class="table-container">
          <table id="scanTable">
            <thead id="tableHead">
              <!-- Populated by JavaScript: two rows (group headers + column headers) -->
            </thead>
            <tbody id="tableBody">
              <!-- Populated by JavaScript -->
            </tbody>
          </table>
        </div>
      </section>
    </div>
    </div> <!-- End of tab-scan -->

    <!-- ====== JOIN SUMMARY TAB ====== -->
    <div class="tab-panel" id="tab-join">
      <!-- Drop Zone: Visible initially for file upload -->
      <div class="drop-zone" id="joinDropZone">
        <div class="drop-zone-icon">üìÅ</div>
        <h2>Drop your query profile JSON here</h2>
        <p>or click to load query</p>
        <input type="file" id="joinFileInput" accept=".json">
      </div>

      <!-- Dashboard: Hidden until a file is loaded -->
      <div class="dashboard" id="joinDashboard">

        <!-- Query Info Panel -->
        <section class="query-info">
          <div class="query-info-header">
            <h2>Query Information</h2>
          </div>
          <div class="query-meta" id="joinQueryMeta">
            <!-- Populated by JavaScript -->
          </div>
        </section>

        <!-- Summary Cards -->
        <div class="cards-container">
          <section class="cards-section" id="joinMemoryCards">
            <h3 class="section-title">Join Memory</h3>
            <div class="summary-cards">
              <!-- Populated by JavaScript -->
            </div>
          </section>

          <section class="cards-section" id="joinTimeCards">
            <h3 class="section-title">Join Time</h3>
            <div class="summary-cards">
              <!-- Populated by JavaScript -->
            </div>
          </section>
        </div>

        <!-- HASH_JOIN Table -->
        <section class="table-section">
          <div class="table-header">
            <h2>üîó HASH_JOIN Operators</h2>
          </div>
          <div class="table-container">
            <table id="joinTable">
              <thead id="joinTableHead">
                <!-- Populated by JavaScript: group headers + column headers -->
              </thead>
              <tbody id="joinTableBody">
                <!-- Populated by JavaScript -->
              </tbody>
            </table>
          </div>
        </section>
      </div>
    </div> <!-- End of tab-join -->

    <!-- ====== QUERY COMPARISON TAB ====== -->
    <div class="tab-panel" id="tab-compare">
      <!-- Two Drop Zones for Comparison -->
      <div class="compare-dropzones">
        <div class="compare-drop baseline" id="compareDropBaseline">
          <h3>üìä Baseline Query</h3>
          <p>Drop the original query profile</p>
          <p class="load-url-link" id="loadUrlBaseline">or Load from URL</p>
          <input type="file" id="compareFileBaseline" accept=".json">
        </div>
        <div class="compare-drop optimized" id="compareDropOptimized">
          <h3>üöÄ Optimized Query</h3>
          <p>Drop the optimized query profile</p>
          <p class="load-url-link" id="loadUrlOptimized">or Load from URL</p>
          <input type="file" id="compareFileOptimized" accept=".json">
        </div>
      </div>

      <!-- Comparison Results (hidden until both files loaded) -->
      <div class="compare-results" id="compareResults">
        <!-- Query Info Headers -->
        <div class="compare-header">
          <div class="compare-query-info baseline">
            <h4>üìä Baseline</h4>
            <div class="meta-row" id="compareMetaBaseline"></div>
          </div>
          <div class="compare-query-info optimized">
            <h4>üöÄ Optimized</h4>
            <div class="meta-row" id="compareMetaOptimized"></div>
          </div>
        </div>

        <!-- Memory Comparison -->
        <div class="compare-cards-section">
          <h3>Memory Comparison</h3>
          <div class="compare-cards-grid" id="compareMemoryCards"></div>
        </div>

        <!-- Time Comparison -->
        <div class="compare-cards-section">
          <h3>Time Comparison</h3>
          <div class="compare-cards-grid" id="compareTimeCards"></div>
        </div>

        <!-- Scan Metrics Comparison -->
        <div class="compare-cards-section">
          <h3>Scan Metrics Comparison</h3>
          <div class="compare-cards-grid" id="compareScanCards"></div>
        </div>

        <!-- Join Metrics Comparison -->
        <div class="compare-cards-section">
          <h3>Join Metrics Comparison</h3>
          <div class="compare-cards-grid" id="compareJoinCards"></div>
        </div>
      </div>
    </div>

    <!-- ====== QUERY PLAN TAB ====== -->
    <div class="tab-panel" id="tab-plan">
      <!-- Drop Zone for Plan -->
      <div class="drop-zone" id="planDropZone">
        <div class="drop-zone-icon">üìÅ</div>
        <h2>Drop your query profile JSON here</h2>
        <p>or click to load query</p>
        <input type="file" id="planFileInput" accept=".json">
      </div>

      <!-- Plan Visualization Container (hidden until file loaded) -->
      <div class="plan-container" id="planContainer" style="display: none;">
        <div class="plan-header">
          <h3>Execution Plan</h3>
        </div>
        <div class="plan-canvas" id="planCanvas">
          <!-- zoom-container will be injected by JS with graph content -->
        </div>
        <!-- UI overlays - children of plan-container, not plan-canvas (avoids overflow:hidden clipping) -->
        <div class="zoom-indicator">100%</div>
        <div class="canvas-toolbar">
          <button id="viewportZoomIn" title="Zoom In (+)">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
              <path d="M8 2a.5.5 0 0 1 .5.5v5h5a.5.5 0 0 1 0 1h-5v5a.5.5 0 0 1-1 0v-5h-5a.5.5 0 0 1 0-1h5v-5A.5.5 0 0 1 8 2z"/>
            </svg>
          </button>
          <button id="viewportZoomOut" title="Zoom Out (-)">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
              <path d="M2 8a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11A.5.5 0 0 1 2 8z"/>
            </svg>
          </button>
          <button id="viewportFit" title="Fit to View (0)">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
              <path d="M1.5 1a.5.5 0 0 0-.5.5v4a.5.5 0 0 1-1 0v-4A1.5 1.5 0 0 1 1.5 0h4a.5.5 0 0 1 0 1h-4zM10 .5a.5.5 0 0 1 .5-.5h4A1.5 1.5 0 0 1 16 1.5v4a.5.5 0 0 1-1 0v-4a.5.5 0 0 0-.5-.5h-4a.5.5 0 0 1-.5-.5zM.5 10a.5.5 0 0 1 .5.5v4a.5.5 0 0 0 .5.5h4a.5.5 0 0 1 0 1h-4A1.5 1.5 0 0 1 0 14.5v-4a.5.5 0 0 1 .5-.5zm15 0a.5.5 0 0 1 .5.5v4a1.5 1.5 0 0 1-1.5 1.5h-4a.5.5 0 0 1 0-1h4a.5.5 0 0 0 .5-.5v-4a.5.5 0 0 1 .5-.5z"/>
            </svg>
          </button>
        </div>
        <div class="viewport-minimap">
          <div class="minimap-content">
            <div class="minimap-nodes"></div>
            <div class="minimap-viewport"></div>
          </div>
        </div>
        <div class="plan-search-bar">
          <span class="search-help" id="planSearchHelp">?</span>
          <div class="search-help-tooltip" id="planSearchHelpTooltip">
            <div class="help-section">Selectors</div>
            <div class="help-row"><code>node=5</code> <span>single node</span></div>
            <div class="help-row"><code>+node=5</code> <span>with ancestors</span></div>
            <div class="help-row"><code>node=5+</code> <span>with descendants</span></div>
            <div class="help-row"><code>+node=5+</code> <span>full lineage</span></div>
            <div class="help-row"><code>type=scan</code> <span>scan / join / exchange</span></div>
            <div class="help-section">Operators</div>
            <div class="help-row"><code>&</code> <span>AND (intersection)</span></div>
            <div class="help-row"><code>,</code> <span>OR (union)</span></div>
            <div class="help-section">Examples</div>
            <div class="help-row"><code>node=5+ & type=scan</code> <span>scans downstream of 5</span></div>
            <div class="help-row"><code>type=scan, type=join</code> <span>all scans or joins</span></div>
            <div class="help-row help-keys"><kbd>Enter</kbd> <span>apply</span> <kbd>Esc</kbd> <span>clear</span> <kbd>/</kbd> <span>focus</span></div>
          </div>
          <div class="search-filter-area" id="planSearchArea">
            <div class="filter-pills" id="planFilterPills"></div>
            <input type="text" id="planSearchInput" placeholder="filter nodes...">
          </div>
          <button id="planSearchClear" class="search-clear" title="Clear (Esc)">√ó</button>
          <button id="planSearchHideToggle" class="search-toggle" title="Toggle mode">dim</button>
        </div>
      </div>
    </div>

    <!-- ====== RAW JSON TAB ====== -->
    <div class="tab-panel" id="tab-raw">
      <!-- Drop Zone for Raw JSON -->
      <div class="drop-zone" id="rawDropZone">
        <div class="drop-zone-icon">üìÅ</div>
        <h2>Drop your query profile JSON here</h2>
        <p>or click to load query</p>
        <input type="file" id="rawFileInput" accept=".json">
      </div>

      <!-- Raw JSON Container (hidden until file loaded) -->
      <div class="raw-container" id="rawContainer" style="display: none;">
        <div class="raw-header">
          <h2>Raw Query JSON</h2>
          <div class="raw-header-actions">
            <div class="raw-search">
              <input type="text" id="rawSearchInput" placeholder="Search JSON..." />
              <span class="search-count" id="rawSearchCount"></span>
              <button class="btn-search-nav" id="rawSearchPrev" title="Previous">&#9650;</button>
              <button class="btn-search-nav" id="rawSearchNext" title="Next">&#9660;</button>
            </div>
            <button class="btn-copy-raw" id="btnCopyRaw">Copy to Clipboard</button>
          </div>
        </div>
        <div class="raw-content">
          <pre id="rawJsonContent"><code></code></pre>
        </div>
      </div>
    </div>
  </main>

  <footer class="site-footer">
    <span class="footer-text">
      Privacy-first analytics ¬∑ No cookies ¬∑ <a href="https://northstar.goatcounter.com" target="_blank" rel="noopener">View stats</a>
    </span>
  </footer>

  <!-- ========================================
       JavaScript Modules
       ======================================== -->
  <script type="module" src="js/main.js"></script>

  <!-- Privacy-respecting analytics (no cookies, no consent popup) -->
  <script data-goatcounter="https://northstar.goatcounter.com/count"
          async src="//gc.zgo.at/count.js"></script>
</body>
</html>
